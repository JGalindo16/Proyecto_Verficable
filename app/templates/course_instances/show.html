<!DOCTYPE html>
<html lang="en">
<head>
    <title>Instancia del Curso</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
    <h2>Instancia del Curso</h2>
    <p><strong>Curso:</strong> {{ course.name }} ({{ course.code }})</p>
    <p><strong>Año:</strong> {{ instance.year }}</p>
    <p><strong>Semestre:</strong> {{ instance.semester }}</p>

    <hr class="my-4">

    <h4>Secciones</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Nombre de la Sección</th>
                <th>Profesor Asignado</th>
                <th>Cantidad de Alumnos Inscritos</th>
            </tr>
        </thead>
        <tbody>
            {% if sections %}
                {% for section in sections %}
                <tr>
                    <td>{{ section.name }}</td>
                    <td>{{ section.professor }}</td>
                    <td>{{ section.student_count }}</td>
                    <td>
                        <form action="/courses/{{ course.id }}/instances/{{ instance.id }}/sections/{{ section.id }}/delete" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar esta sección?')">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" class="text-center">No hay secciones disponibles</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#addSectionModal">Agregar Sección</button>

    <!-- Modal -->
    <div class="modal fade" id="addSectionModal" tabindex="-1" aria-labelledby="addSectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/courses/{{ course.id }}/instances/{{ instance.id }}/sections" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addSectionModalLabel">Agregar Sección</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="sectionNumber">Número de Sección</label>
                                    <input type="number" class="form-control" id="sectionNumber" name="section_name" required min="1" max="99">
                                    <small class="form-text text-muted">Ingrese un número para identificar la sección (ej: 1, 2, 3)</small>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="professor">Profesor</label>
                                    <select class="form-select" id="professor" name="professor_id" required>
                                        <option value="">-- Seleccione un Profesor --</option>
                                        {% for professor in professors %}
                                        <option value="{{ professor.id }}">{{ professor.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="studentSearch">Buscar Alumnos</label>
                                    <input type="text" class="form-control mb-2" id="studentSearch" placeholder="Buscar por nombre...">
                                    
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Alumnos Disponibles</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllStudents">Seleccionar Todos</button>
                                        </div>
                                        <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                            <div id="studentList">
                                                {% for student in students %}
                                                <div class="form-check student-item">
                                                    <input class="form-check-input student-checkbox" type="checkbox" id="student{{ student.id }}" name="student_ids" value="{{ student.id }}">
                                                    <label class="form-check-label" for="student{{ student.id }}">
                                                        {{ student.name }}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <small class="text-muted">Alumnos seleccionados: <span id="selectedCount">0</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Sección</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const studentSearch = document.getElementById('studentSearch');
        const studentItems = document.querySelectorAll('.student-item');
        const studentCheckboxes = document.querySelectorAll('.student-checkbox');
        const selectAllBtn = document.getElementById('selectAllStudents');
        const selectedCountEl = document.getElementById('selectedCount');
        
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.student-checkbox:checked').length;
            selectedCountEl.textContent = selectedCount;
        }
        
        studentSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            studentItems.forEach(item => {
                const studentName = item.textContent.trim().toLowerCase();
                if (studentName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        selectAllBtn.addEventListener('click', function() {
            const allSelected = document.querySelectorAll('.student-checkbox:checked').length === studentCheckboxes.length;
            
            studentCheckboxes.forEach(checkbox => {
                const item = checkbox.closest('.student-item');
                if (item.style.display !== 'none') {
                    checkbox.checked = !allSelected;
                }
            });
            
            updateSelectedCount();
            this.textContent = allSelected ? 'Seleccionar Todos' : 'Deseleccionar Todos';
        });
        
        studentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        updateSelectedCount();
        
        const modal = document.getElementById('addSectionModal');
        modal.addEventListener('shown.bs.modal', function() {
            studentSearch.value = '';
            studentItems.forEach(item => {
                item.style.display = 'block';
            });
        });
    });
    </script>

    <a href="/courses/{{ course.id }}" class="btn btn-primary mt-3">Volver al curso</a>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>