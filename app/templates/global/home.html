{% extends "global/base.html" %}

{% block title %}Inicio | Sistema Acad√©mico{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 text-center">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <h1 class="mb-4">Sistema de Gesti√≥n Acad√©mica</h1>
        <p class="lead mb-5">Selecciona una secci√≥n para administrar:</p>

        <div class="d-grid gap-3 col-md-6 mx-auto">
            <a href="/courses" class="btn btn-outline-dark btn-lg">Cursos</a>
            <a href="/professors" class="btn btn-outline-primary btn-lg">Profesores</a>
            <a href="/students" class="btn btn-outline-success btn-lg">Estudiantes</a>
            <button id="start-json-tour" class="btn btn-outline-warning btn-lg" data-intro="Comienza aqu√≠ para cargar los archivos JSON en orden">Cargar JSON</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css" />

<script>
window.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('start-json-tour');
    if (!startBtn) return;

    function handleModalFormAndContinue(modalId, nextStepFn) {
        const form = document.querySelector(`#${modalId} form`);
        const modalElement = document.getElementById(modalId);
        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        // Cierre manual del modal tambi√©n contin√∫a el tour
        modalElement.addEventListener('hidden.bs.modal', () => {
            setTimeout(nextStepFn, 300);
        }, { once: true });

        if (!form) return;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const action = form.getAttribute('action') || window.location.pathname;

            fetch(action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.redirected) throw new Error('Error en la carga del archivo');
                bootstrap.Modal.getInstance(modalElement).hide();
            })
            .catch(err => {
                alert("Error al subir archivo: " + err.message);
            });
        }, { once: true });
    }

    function showFinalFlashes() {
        document.querySelectorAll('.alert').forEach(alert => {
            alert.classList.add('show');
            alert.style.display = 'block';
        });
    }

    startBtn.addEventListener('click', () => {
        const intro = introJs();

        intro.setOptions({
            steps: [
                {
                    title: 'üöÄ Bienvenido al sistema de carga JSON',
                    intro: 'Este tour te guiar√° paso a paso para subir los archivos en el orden correcto sin romper la aplicaci√≥n.'
                },
                {
                    title: 'üìÑ Paso 1: Subir Alumnos',
                    intro: 'Sube <code>1-alumnos.json</code> con los datos base de los estudiantes.'
                },
                {
                    element: '#start-json-tour',
                    intro: 'Haz clic en "Subir Alumnos". Puedes omitirlo cerrando el siguiente modal.',
                    position: 'bottom'
                }
            ],
            showProgress: true,
            doneLabel: 'Subir alumnos'
        });

        intro.oncomplete(() => {
            handleModalFormAndContinue('modalUploadAlumnos', () => {
                const pasoProfesores = introJs();
                pasoProfesores.setOptions({
                    steps: [
                        {
                            title: 'üë®‚Äçüè´ Paso 2: Subir Profesores',
                            intro: 'Sube <code>2-profesores.json</code> con los datos del cuerpo docente.'
                        },
                        {
                            element: '#start-json-tour',
                            intro: 'Haz clic en "Subir Profesores". Puedes omitirlo cerrando el siguiente modal.',
                            position: 'bottom'
                        }
                    ],
                    doneLabel: 'Subir profesores'
                });

                pasoProfesores.oncomplete(() => {
                    handleModalFormAndContinue('modalUploadProfesores', () => {
                        const pasoCursos = introJs();
                        pasoCursos.setOptions({
                            steps: [
                                {
                                    title: 'üìò Paso 3: Subir Cursos',
                                    intro: 'Sube <code>3-cursos.json</code> con informaci√≥n de cursos y prerrequisitos.'
                                },
                                {
                                    element: '#start-json-tour',
                                    intro: 'Haz clic en "Subir Cursos". Puedes omitirlo cerrando el siguiente modal.',
                                    position: 'bottom'
                                }
                            ],
                            doneLabel: 'Subir cursos'
                        });

                        pasoCursos.oncomplete(() => {
                            handleModalFormAndContinue('modalUploadCursos', () => {
                                const pasoInstancias = introJs();
                                pasoInstancias.setOptions({
                                    steps: [
                                        {
                                            title: 'üìÖ Paso 4: Subir Instancias',
                                            intro: 'Sube <code>4-instancias_cursos.json</code> con a√±o y semestre.'
                                        },
                                        {
                                            element: '#start-json-tour',
                                            intro: 'Haz clic en "Subir Instancias". Puedes omitirlo cerrando el siguiente modal.',
                                            position: 'bottom'
                                        }
                                    ],
                                    doneLabel: 'Subir instancias'
                                });

                                pasoInstancias.oncomplete(() => {
                                    handleModalFormAndContinue('modalUploadInstancias', () => {
                                        const pasoInscripciones = introJs();
                                        pasoInscripciones.setOptions({
                                            steps: [
                                                {
                                                    title: 'üë• Paso 5: Inscripciones',
                                                    intro: 'Sube <code>6-alumnos_por_seccion.json</code> para inscribir alumnos.'
                                                },
                                                {
                                                    element: '#start-json-tour',
                                                    intro: 'Haz clic en "Subir Inscripciones". Puedes omitirlo cerrando el siguiente modal.',
                                                    position: 'bottom'
                                                }
                                            ],
                                            doneLabel: 'Subir inscripciones'
                                        });

                                        pasoInscripciones.oncomplete(() => {
                                            handleModalFormAndContinue('modalUploadInscripciones', () => {
                                                const pasoSalas = introJs();
                                                pasoSalas.setOptions({
                                                    steps: [
                                                        {
                                                            title: 'üè´ Paso 6: Subir Salas de Clase',
                                                            intro: 'Sube <code>8-salas_de_clases.json</code> con informaci√≥n de salas.'
                                                        },
                                                        {
                                                            element: '#start-json-tour',
                                                            intro: 'Haz clic en "Subir Salas". Puedes omitirlo cerrando el siguiente modal.',
                                                            position: 'bottom'
                                                        }
                                                    ],
                                                    doneLabel: 'Subir salas'
                                                });

                                                pasoSalas.oncomplete(() => {
                                                    handleModalFormAndContinue('modalUploadSalas', () => {
                                                        const finalStep = introJs();
                                                        finalStep.setOptions({
                                                            steps: [
                                                                {
                                                                    title: 'üéâ ¬°Tour finalizado!',
                                                                    intro: 'Has completado el tour. Se omitieron las secciones y notas por tiempo, pero puedes cargarlas manualmente.'
                                                                }
                                                            ],
                                                            doneLabel: 'Finalizar'
                                                        });

                                                        finalStep.oncomplete(showFinalFlashes);
                                                        finalStep.start();
                                                    });
                                                });

                                                pasoSalas.start();
                                            });
                                        });

                                        pasoInscripciones.start();
                                    });
                                });

                                pasoInstancias.start();
                            });
                        });

                        pasoCursos.start();
                    });
                });

                pasoProfesores.start();
            });
        });

        intro.start();
    });
});
</script>
{% include 'json_upload/modal_alumnos.html' %}
{% include 'json_upload/modal_profesores.html' %}
{% include 'json_upload/modal_cursos.html' %}
{% include 'json_upload/modal_instancias.html' %}
{% include 'json_upload/modal_inscripciones.html' %}
{% include 'json_upload/modal_salas.html' %}
{% endblock %}