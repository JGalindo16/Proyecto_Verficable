<!DOCTYPE html>
<html lang="en">
<head>
    <title>Notas de la Sección</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .editable-cell[contenteditable="true"] {
            background-color: #fff3cd;
            cursor: pointer;
        }
        .editable-cell:focus {
            outline: 2px solid #ffc107;
        }
    </style>
</head>
<body class="container mt-5">
    <h2>Notas de la Sección: {{ section.name }}</h2>
    <p>Curso: {{ course.name }} ({{ course.code }}) - Año: {{ instance.year }} - Semestre: {{ instance.semester }}</p>

    <div class="mb-4">
        <a href="/courses/{{ course.id }}/instances/{{ instance.id }}/sections/{{ section.id }}" class="btn btn-primary">
            Volver a Sección
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="my-0">Pesos de las Evaluaciones</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for eval_type, weight in evaluation_weights.items() %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header bg-light">
                            <strong>{{ eval_type }}:</strong> {{ (weight * 100)|round|int }}%
                        </div>
                        <div class="card-body">
                            {% if students_data|length > 0 %}
                                {% set student = students_data.values()|list|first %}
                                {% set evals = student.evaluations.get(eval_type, []) %}
                                <ul class="list-group list-group-flush">
                                {% for eval in evals %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ eval.name }}
                                        <span class="badge bg-secondary">{{ (eval.specific_weight * 100)|round|int }}%</span>
                                    </li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">No hay evaluaciones disponibles</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr class="table-dark">
                    <th rowspan="2">Estudiante</th>
                    {% for eval_type in evaluation_types %}
                        {% set student = students_data.values()|list|first %}
                        {% set evals = student.evaluations.get(eval_type, []) %}
                        <th colspan="{{ evals|length + 1 }}" class="text-center">{{ eval_type }}</th>
                    {% endfor %}
                    <th rowspan="2">Promedio Final</th>
                </tr>
                <tr class="table-dark">
                    {% for eval_type in evaluation_types %}
                        {% set student = students_data.values()|list|first %}
                        {% set evals = student.evaluations.get(eval_type, []) %}
                        {% for eval in evals %}
                            <th>{{ eval.name }}</th>
                        {% endfor %}
                        <th class="bg-light-yellow">Prom.</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for student_id, student in students_data.items() %}
                <tr data-student-id="{{ student_id }}">
                    <td>{{ student.name }}</td>
                    {% for eval_type in evaluation_types %}
                        {% set evals = student.evaluations.get(eval_type, []) %}
                        {% for eval in evals %}
                        <td>
                            <span class="editable-cell"
                                  contenteditable="true"
                                  title="Presiona Enter para guardar la nota"
                                  data-instance-eval-id="{{ eval.instance_eval_id }}"
                                  data-score="{{ eval.score }}"
                                  data-section-id="{{ section.id }}"
                                  data-student-id="{{ student_id }}"
                                  data-type="{{ eval_type }}">
                                {{ eval.score if eval.score is not none else '-' }}
                            </span>
                        </td>
                        {% endfor %}
                        <td class="bg-light-yellow" data-type-average="{{ eval_type }}" data-weight="{{ evaluation_weights[eval_type] }}">
                            {{ student.type_averages.get(eval_type, '-') }}
                        </td>
                    {% endfor %}
                    <td class="bg-light-blue" data-final-average><strong>{{ student.final_average }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.querySelectorAll('.editable-cell').forEach(cell => {
        cell.addEventListener('keydown', async function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();

                const newScore = parseFloat(this.innerText.trim());
                if (isNaN(newScore) || newScore < 1 || newScore > 7) {
                    alert('Ingrese una nota válida entre 1.0 y 7.0');
                    this.innerText = this.dataset.score || '-';
                    return;
                }

                const studentId = this.closest('tr').dataset.studentId;
                const instanceEvalId = this.dataset.instanceEvalId;
                const sectionId = this.dataset.sectionId;
                const type = this.dataset.type;

                const res = await fetch('/grades/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        section_id: sectionId,
                        student_id: studentId,
                        instance_eval_id: instanceEvalId,
                        score: newScore
                    })
                });

                const json = await res.json();
                if (!json.success) {
                    alert('Error al guardar la nota');
                    this.innerText = this.dataset.score || '-';
                    return;
                }

                this.dataset.score = newScore.toFixed(1);
                this.innerText = newScore.toFixed(1);

                const row = this.closest('tr');
                const cells = row.querySelectorAll(`.editable-cell[data-type="${type}"]`);
                let sum = 0, count = 0;
                cells.forEach(c => {
                    const s = parseFloat(c.innerText);
                    if (!isNaN(s)) {
                        sum += s;
                        count += 1;
                    }
                });
                const avg = count > 0 ? (sum / count).toFixed(1) : '-';
                const avgCell = row.querySelector(`[data-type-average="${type}"]`);
                avgCell.innerText = avg;

                // Recalcular promedio final con pesos
                const averages = row.querySelectorAll('[data-type-average]');
                let total = 0;
                averages.forEach(el => {
                    const weight = parseFloat(el.dataset.weight || 0);
                    const val = parseFloat(el.innerText);
                    if (!isNaN(val)) total += val * weight;
                });
                row.querySelector('[data-final-average]').innerText = total.toFixed(1);
            }
        });
    });
    </script>
</body>
</html>